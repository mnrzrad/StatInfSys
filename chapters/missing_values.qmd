---
engine: knitr
filters: 
  - webr
---

```{r setup, include=FALSE}
required_packages <- c("VIM", "naniar", "mice", "dplyr")

for (pkg in required_packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, repos = "https://cloud.r-project.org")
    library(pkg, character.only = TRUE)
  }
}
```


```{webr-r}
#| context: setup
library(tidyverse)
```

# Missing Values

Missing values happen when data for an observation is not recorded. This can occur if, for example, a participant drops out of a study, a machine fails, someone skips a survey question, or a recording error is made.

Missing data are usually shown as an empty cell, a $.$ (dot), or a $*$ (asterisk). Invalid entries -- like text in a numeric column or a `N/A` error -- are also treated as missing.

::: callout-caution
Sometimes older datasets use numbers like $99999$ to mark missing data. In such cases, replace them with a proper missing value indicator before analysis.
:::

::: callout-tip
The missing values can take the form of blank cells, null values or special symbols like `NA`, `NaN` or "*unknown*"
:::

## Importance of Handling Missing Values

Handeling missing values is essential for accurate and reliable analysis. Key reasons include:

- **Better Model Accuracy**: Fixing missing data improves predictions and model performance.
  
- **Maintained Sample Size**: Imputation or careful removal keeps more data available for analysis.
  
- **Reduced Bias**: Proper handeling prevents distorted or misleading results. 
  
- **Stronger Decisions**: Clean data leads to more confident and trustworthy conclusions. 

## Challenges Caused by Missing Values

Missing data can create problems such as 

- **Smaller Sample Size**: Removing rows with missing values reduces data and reliability. 
  
- **Biased Results**: Non-random missing data can lead to false conclusions. 
  
- **Limited Analysis**: Many methods can not handle missing data, restricting analysis options. 

## Common Reasons for Missing Data

Data may be missing due to:
- **Technical issues**: Equipment failure or data transfer errors.
  
- **Human errors**: Mistakes in entry or recording.
  
- **Privacy concerns**: Withholding sensitice information. 

- **Processing problems**: Errors during data preparation or transformation.

## Figure out Why the Data Is Missing

Before handling missing values, it is IMPORTANT to understand why they are missing -- this is part of what we can call **data intuition**, or the ability to look closely at your data and reason about what is happening.

Ask yourself this key question:

** Is the value missing because it was recorded, or because it does not exist?**

- If it **does not exist** (for example, the height of the oldest child of someone who does not have any children), it does not make sense to fill it in -- keep it as `NaN`.
  
- If it **was not recorded** (for example, a measurement that someone forgot to take), you may estimate it using other available data. This process is called **imputation**.

Undertanding the reason behind missing values you decide whether to *leave them as missing* or *fill them in intelligently*.


## Example Dataset

Let us start with an example, the `airquality` dataset, which records daily air quality measurements in New York (1973). 
```{webr-r}
#| warning: false
#| message: false
#| autorun: true
#| out-width: 80%

data("airquality")

summary(airquality)
```
It has missing values in `Ozone` and `Solar.R` columns.

There are some libraries that can help us visualize missing data patterns, such as `naniar`, `VIM`, and `mice`

```{webr-r}
#| warning: false
#| message: false
#| autorun: true
#| out-width: 80%

# Install (if needed)
# install.packages("naniar")

library(naniar)

# Proportion of missing values
prop_miss(airquality)

# Count missing values per column
miss_var_summary(airquality)

# Visualize missingness
vis_miss(airquality)

# Bar plot of missing values per variable
gg_miss_var(airquality)
```

```{r}
#| autorun: true
#| out-width: 80%
#| warning: false
#| message: false

# Install (if needed)
# install.packages("VIM")
library(VIM)

# Aggregation plot of missingness
aggr(airquality, numbers = TRUE, sortVars = TRUE)
```

```{webr-r}
#| autorun: true
#| out-width: 80%
#| warning: false
#| message: false
library(mice)

md.pattern(airquality)
```

## Types of Missing Data
Sometimes, we expect a value in our dataset, but it is not there. For example, a survey respondent may skip a question, or a sensor may fail to record a measurement, or a file got lost. These are missing values. But **not all missing values happen for the same reason** -- and the reason matters, because it affects how we should handle them.

1. **Missing Completely at Random (MCAR)**: The missingness is entirely random and unrelated to any other data. 

Think of this as:

> *The data went missing by accident.*

This meissingness has **nothing to do** with any variable in your dataset. It is just a bad luck -- like someone spilled coffee on some forms or a sensor failed. Everyone had an equal chance of having missing data.

**For example**, a few labe samples are lost because a fridge broke. This has nothing to do with the people or the measurements. 
::: callout-important
If data are MCAR, your analysis will still be fair and unbiased, even if you remove those cases.
:::

2. **MAR -- Missing at Random**

Think of this as:

> The data is missing for a reason we know about.

This missingness is related to **other variables** that we have data for. But it is not related to the value that is missing itself. 

**For example**, you ask people about their income, and you notice that younger people are less likely to answer. So the missingness depends on *age* (which you know), not on *income* itself.

::: callout-important
You can fix this by using the other variables (like *age*) to estimate or impute the missing ones.
:::

3. **MNAR -- Missing Not at Random**

Think of this as:

> The data is missing because of the value itself.

The missingness is related to the **thing that is missing** or maybe you do not know the reason at all. 

**For example**, some people do not report their weight because they feel uncomfortable about it -- so the missingness depends on *weight* itself.

::: callout-important
This is the hardes case -- because we can not fix it easily. You may need special models or collect more data.
:::



::::: panel-tabset
## Exercise

For each of situation below, decide whether the missing data are: (A) Missing Completly at Random (MCAR), (B) Missing at Random (MAR), or (C) Missing Not at Random (MNAR). 

**Question 1**
During data entry, some survey responses were lost because the computer crashed before saving. What type of missingness is this?

**Question 2**
In a health survey, people with higher income are less likely to reveal their income, but everyone answered all other questions. What type of missingness is this?

**Question 3**
A researcher measures blood pressure, but the cuff sometimes fails to inflate due to a machine error, affecting random participants. What type of missingness is this?

**Question 4**
In a questionnaire about mental health, people with higher levels of stress are more likely to skip the “stress level” question. What type of missingness is this?

**Question 5**
Some students forgot to write their age, but we notice that older students tend to complete the survey more carefully and rarely miss answers. What type of missingness is this?

**Question 6**
A dataset on patient weight is missing for extremely obese individuals because the hospital’s scale cannot record weights above $200$ kg. What type of missingness is this?

**Question 7**
An old version of a form did not include the “education level” question, but the new form does. What type of missingness is this?

## Solution
::: {.solution exercise="ex_m_1"}

**Question 1:** MCAR – Data lost by accident; unrelated to any variable.  
**Question 2:** MNAR – Missingness depends on the income value itself.  
**Question 3:** MCAR – Random machine fault.  
**Question 4:** MNAR – Missingness depends on stress level itself.  
**Question 5:** MAR – Missingness depends on another variable (age).  
**Question 6:** MNAR – Missing because of the actual value (very high weight).  
**Question 7:** MAR – Missingness linked to the form version (observed variable).

:::

:::::
